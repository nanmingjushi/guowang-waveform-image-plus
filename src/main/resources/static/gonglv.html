<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>功率计算</title>
    <style>
        body { background:#fafbfc; min-height:100vh; font-family:'Segoe UI','Microsoft YaHei',Arial,sans-serif; color:#1d272b; margin:0; }
        h2 { color:#1d9276; text-align:center; margin:32px 0 28px; font-size:2em; letter-spacing:2px; font-weight:600; }
        form { display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:12px; }
        .file-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        label { color:#168c60; font-weight:600; }
        input[type="file"] { padding:10px 18px; border-radius:15px; border:1.5px solid #d7ece0; background:#fff; color:#168c60; font-size:1em; outline:none; }
        input[type="file"]:focus { border-color:#23cc97; background:#f5fff8; }
        button, #downloadWordBtn {
            background:linear-gradient(90deg,#1db37b 0%,#a5eddc 100%); border:none; color:#176c4e; padding:11px 36px; border-radius:24px;
            font-size:1.08em; font-weight:bold; cursor:pointer; letter-spacing:1px; box-shadow:0 2px 12px #a0ede7aa; transition:background .15s, transform .15s;
        }
        button:hover, #downloadWordBtn:hover { background:linear-gradient(90deg,#23cc97 0%,#b8fae2 100%); color:#0b4236; transform:translateY(-2px) scale(1.035); }
        hr { border:0; border-top:1px solid #e6ebe9; margin:20px 0; }
        table {
            border-collapse:collapse; margin:26px auto 0; width:100%; max-width:900px; min-width:320px;
            box-shadow:0 2px 20px #e6f9f6cc; border-radius:12px; background:#fff; overflow:hidden; font-size:1.07em;
        }
        th, td { border:none; padding:13px 8px; text-align:center; }
        th { background:#ecfaf6; color:#189c72; font-size:1.08em; font-weight:700; letter-spacing:1px; }
        tr:not(:last-child) td { border-bottom:1px solid #f2f4f4; }
        td { background:transparent; color:#273b37; font-size:1.07em; }
        td[style*="color:red"] { color:#e84d3d !important; font-weight:bold; }
        @media (max-width: 900px){ table{ font-size:.97em; max-width:99vw; } th,td{ padding:7px 2px; } }
    </style>
</head>
<body>
<h2>功率计算</h2>

<form id="uploadForm">
    <div class="file-row">
        <label>三相电压图：</label>
        <!-- 支持多张 -->
        <input type="file" id="voltageFiles" name="voltageFiles" accept="image/*" multiple>
    </div>
    <div class="file-row">
        <label>三相电流图：</label>
        <!-- 支持多张 -->
        <input type="file" id="currentFiles" name="currentFiles" accept="image/*" multiple>
    </div>
    <button type="submit">上传并计算</button>
</form>

<hr/>
<div id="result"></div>

<div style="text-align:center; margin-top:10px;">
    <button id="downloadWordBtn">导出结果表格到 Word</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
<script>
    let lastData = [];

    document.getElementById('uploadForm').addEventListener('submit', function(e){
        e.preventDefault();

        const vFiles = document.getElementById('voltageFiles').files;
        const iFiles = document.getElementById('currentFiles').files;
        if (!vFiles.length || !iFiles.length){
            alert('请同时选择三相电压图和三相电流图！');
            return;
        }

        const fd = new FormData();
        // 与后端参数名保持一致：voltageFiles / currentFiles
        for (let i=0;i<vFiles.length;i++) fd.append('voltageFiles', vFiles[i]);
        for (let i=0;i<iFiles.length;i++) fd.append('currentFiles', iFiles[i]);

        fetch('/gonglv/upload', { method:'POST', body: fd })
            .then(r => r.json())
            .then(data => {
                console.log('resp:', data);   // 打印后端原始响应，便于调试
                lastData = data;
                renderTable(data);
            })
            .catch(err => { document.getElementById('result').innerText = '上传失败：' + err; });
    });

    function renderTable(data){
        if (!Array.isArray(data) || data.length === 0){
            document.getElementById('result').innerText = '没有结果';
            return;
        }
        const rows = [];
        for (const item of data){
            const filePairName = item.filePair || '';
            const phases = Array.isArray(item.phases) ? item.phases : [];
            const rowSpan = Math.max(1, phases.length);
            if (phases.length === 0){
                rows.push(`<tr>
          <td>${filePairName}</td>
          <td colspan="7" style="color:red">未检测到任何相别数据</td>
        </tr>`);
            } else {
                for (let i=0;i<phases.length;i++){
                    const p = phases[i] || {};
                    rows.push(`<tr>
            ${i===0 ? `<td rowspan="${rowSpan}">${filePairName}</td>` : ``}
            <td>${p.phase ?? ''}</td>
            <td>${fmt(p.vrms_kV, 3)}</td>
            <td>${fmt(p.irms_A, 3)}</td>
            <td>${fmt(p.P_kW, 3)}</td>
            <td>${fmt(p.S_kVA, 3)}</td>
            <td>${fmt(p.PF, 3)}</td>
            <td style="color:red">${p.error ? p.error : ''}</td>
          </tr>`);
                }
            }
        }

        const html = `
      <table>
        <thead>
          <tr>
            <th>文件对</th>
            <th>相别</th>
            <th>电压有效值(kV)</th>
            <th>电流有效值(A)</th>
            <th>有功功率(kW)</th>
            <th>视在功率(kVA)</th>
            <th>功率因数</th>
            <th>异常信息</th>
          </tr>
        </thead>
        <tbody>${rows.join('')}</tbody>
      </table>
    `;
        document.getElementById('result').innerHTML = html;
    }

    // 安全格式化：只有是数字才显示，避免把 NaN/undefined 变成 0.000
    function fmt(v, d=3){ return (typeof v === 'number' && isFinite(v)) ? v.toFixed(d) : ''; }

    document.getElementById('downloadWordBtn').onclick = async function(){
        if (!Array.isArray(lastData) || !lastData.length){
            alert('请先上传并计算！');
            return;
        }
        await exportWord(lastData);
    };

    async function exportWord(data){
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, AlignmentType } = window.docx;
        const header = new TableRow({ children: [
                new TableCell({ children:[new Paragraph('文件对')] }),
                new TableCell({ children:[new Paragraph('相别')] }),
                new TableCell({ children:[new Paragraph('电压有效值(kV)')] }),
                new TableCell({ children:[new Paragraph('电流有效值(A)')] }),
                new TableCell({ children:[new Paragraph('有功功率(kW)')] }),
                new TableCell({ children:[new Paragraph('视在功率(kVA)')] }),
                new TableCell({ children:[new Paragraph('功率因数')] })
            ]});
        const rows = [header];

        for (const item of data){
            const filePairName = item.filePair || '';
            const phases = Array.isArray(item.phases) ? item.phases : [];
            if (!phases.length){
                rows.push(new TableRow({ children: [
                        new TableCell({ children:[new Paragraph(filePairName)] }),
                        new TableCell({ children:[new Paragraph('无')] }),
                        new TableCell({ children:[new Paragraph('')] }),
                        new TableCell({ children:[new Paragraph('')] }),
                        new TableCell({ children:[new Paragraph('')] }),
                        new TableCell({ children:[new Paragraph('')] }),
                        new TableCell({ children:[new Paragraph('')] })
                    ]}));
                continue;
            }
            for (const p of phases){
                rows.push(new TableRow({ children: [
                        new TableCell({ children:[new Paragraph(filePairName)] }),
                        new TableCell({ children:[new Paragraph(p.phase ?? '')] }),
                        new TableCell({ children:[new Paragraph(outNum(p.vrms_kV))] }),
                        new TableCell({ children:[new Paragraph(outNum(p.irms_A))] }),
                        new TableCell({ children:[new Paragraph(outNum(p.P_kW))] }),
                        new TableCell({ children:[new Paragraph(outNum(p.S_kVA))] }),
                        new TableCell({ children:[new Paragraph(outNum(p.PF))] })
                    ]}));
            }
        }

        const table = new Table({ rows, width: { size: 100, type: WidthType.PERCENTAGE } });
        const doc = new Document({
            sections: [{ children: [
                    new Paragraph({ text:'波形图像功率计算', heading:'Heading1', alignment: AlignmentType.CENTER }),
                    table
                ]}]
        });

        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = '波形图像功率计算.docx';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    function outNum(v){ return (typeof v==='number' && isFinite(v)) ? v.toFixed(3) : ''; }
</script>
</body>
</html>
